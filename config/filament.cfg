[gcode_macro FILAMENT_UNLOAD]
gcode:
    {% set EXTRUDER_TEMP = params.TEMP|default(230)|int %}
    M117 Unloading filament...
    G90                     # set toolhead to absolute position
    G1 Z40 F50000
    G1 X150 Y30 F50000     # move up and to front/center to straighten filament path
    M109 S{EXTRUDER_TEMP}   # heat up the hotend
    M83                     # set extruder to relative extrusion
    G1 E3   F300            # extrude slowly to soften tip of filament
    G1 E-30 F9000         # quickly yank filament back clear of hotend
    G1 E-50 F1800           # ensure filament is clear of extruder gears
    G1 E-30 F1800           # splitting up E-80 to 2 commands, in order not to break max_extude_only_distance=50
    M82                     # set extruder to absolute extrusion
[gcode_macro FILAMENT_LOAD]
gcode:
    {% set EXTRUDER_TEMP = params.TEMP|default(230)|int %}
    M117 Loading filament...
    M83                     # set extruder to relative extrusion
    G90                     # set toolhead to absolute position
    G1 Z40 F50000
    G1 X150 Y30 F50000     # move up and to front/center to straighten filament path
    M109 S{EXTRUDER_TEMP}   # heat up the hotend
    G1 E50 F300             # extrude filament through into hotend
    G1 E40 F100
    M82                     # set extruder to absolute extrusion
    M400                        ; wait for moves to finish
